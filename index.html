
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>神経衰弱 対戦モード</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    #gameBoard { display: grid; grid-template-columns: repeat(4, 100px); gap: 10px; justify-content: center; margin-top: 20px; }
    .card { width: 100px; height: 100px; background: #ccc; position: relative; cursor: pointer; }
    .card img { width: 100%; height: 100%; object-fit: cover; display: block; }
    #uploadedList img { width: 50px; height: 50px; object-fit: cover; margin: 5px; }
    .image-entry { display: inline-block; position: relative; margin: 5px; }
    .remove-btn {
      position: absolute; top: 0; right: 0;
      background: red; color: white; border: none;
      font-size: 12px; cursor: pointer; padding: 2px 5px;
    }
  </style>
</head>
<body>
  <h2>神経衰弱（最大4人対戦）</h2>
  <label>プレイヤー人数: 
    <select id="playerCount">
      <option value="1">1人</option>
      <option value="2" selected>2人</option>
      <option value="3">3人</option>
      <option value="4">4人</option>
    </select>
  </label>
  <div id="nameInputs" style="margin: 10px;"></div>
  <p id="turnInfo">現在のプレイヤー: 1</p>
  <p id="scoreInfo">スコア - プレイヤー1: 0 / プレイヤー2: 0</p>

  <p>① 「画像を選択」で画像を <strong>1枚ずつ追加</strong><br>
     ② 最低2枚追加後、「ゲームスタート」ボタンが有効になります。</p>

  <input type="file" id="imageUploader" accept="image/*" />
  <button id="addImageBtn">➕ 画像を追加</button>
  <button id="toggleUploadedBtn">アップロード画像を非表示</button>
  <div id="uploadedList" style="display:block;"></div>

  <br><button id="startButton" disabled>ゲームスタート</button>
  <div id="gameBoard"></div>

  <div id="imageModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:999;">
    <img id="modalImage" src="" style="max-width:80%;max-height:80%;">
  </div>

  <script>
    let uploadedImages = [];
    let playerCount = 2;
    let currentPlayer = 0;
    let scores = [0, 0, 0, 0];
    let playerNames = ["プレイヤー1", "プレイヤー2", "プレイヤー3", "プレイヤー4"];
    let firstCard = null;
    let lockBoard = false;
    let hideUploaded = false;

    function updateUploadedList() {
      const list = document.getElementById("uploadedList");
      const currentDisplay = list.style.display;
      list.style.display = "block";
      list.innerHTML = "";
      uploadedImages.forEach((src, index) => {
        const entry = document.createElement("div");
        entry.className = "image-entry";
        const img = document.createElement("img");
        img.src = src;
        const btn = document.createElement("button");
        btn.textContent = "×";
        btn.className = "remove-btn";
        btn.onclick = () => {
          uploadedImages.splice(index, 1);
          updateUploadedList();
          document.getElementById("startButton").disabled = uploadedImages.length < 2;
        };
        entry.appendChild(img);
        entry.appendChild(btn);
        list.appendChild(entry);
      });
      list.style.display = currentDisplay;
    }

    document.getElementById("addImageBtn").onclick = () => {
      const file = document.getElementById("imageUploader").files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        uploadedImages.push(e.target.result);
        updateUploadedList();
        if (uploadedImages.length >= 2) {
          document.getElementById("startButton").disabled = false;
        }
      };
      reader.readAsDataURL(file);
      document.getElementById("imageUploader").value = "";
    };

    document.getElementById("toggleUploadedBtn").onclick = function () {
      hideUploaded = !hideUploaded;
      const list = document.getElementById("uploadedList");
      list.style.display = hideUploaded ? "none" : "block";
      this.textContent = hideUploaded ? "アップロード画像を表示" : "アップロード画像を非表示";
    };

    document.getElementById("playerCount").addEventListener("change", function() {
      const nameInputs = document.getElementById("nameInputs");
      nameInputs.innerHTML = "";
      playerCount = parseInt(this.value);
      scores = [0, 0, 0, 0];
      playerNames = [];
      for (let i = 0; i < playerCount; i++) {
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "プレイヤー" + (i + 1);
        input.value = "プレイヤー" + (i + 1);
        input.dataset.index = i;
        input.addEventListener("input", () => {
          playerNames[i] = input.value || "プレイヤー" + (i + 1);
          updateScoreDisplay();
        });
        nameInputs.appendChild(input);
        playerNames[i] = input.value;
      }
      updateScoreDisplay();
    });

    function updateScoreDisplay() {
      const nameFallback = index => playerNames[index] || "プレイヤー" + (index + 1);
      let scoreText = [];
      for (let i = 0; i < playerCount; i++) {
        scoreText.push(`${nameFallback(i)}: ${scores[i]}`);
      }
      document.getElementById("scoreInfo").textContent = "スコア - " + scoreText.join(" / ");
      document.getElementById("turnInfo").textContent = "現在のプレイヤー: " + nameFallback(currentPlayer);
    }

    function checkWin() {
      const totalPairs = uploadedImages.length;
      const totalScore = scores.slice(0, playerCount).reduce((a, b) => a + b, 0);
      if (totalScore === totalPairs) {
        let maxScore = Math.max(...scores.slice(0, playerCount));
        let winners = [];
        for (let i = 0; i < playerCount; i++) {
          if (scores[i] === maxScore) {
            winners.push(playerNames[i] || "プレイヤー" + (i + 1));
          }
        }
        setTimeout(() => {
          alert("🎉 勝者: " + winners.join("・") + "（スコア: " + maxScore + "）");
        }, 100);
      }
    }

    document.getElementById("startButton").onclick = () => {
      const board = document.getElementById("gameBoard");
      board.innerHTML = "";
      const pairs = [...uploadedImages, ...uploadedImages].sort(() => 0.5 - Math.random());
      pairs.forEach(src => {
        const card = document.createElement("div");
        card.className = "card";
        const img = document.createElement("img");
        img.src = src;
        img.style.visibility = "hidden";
        card.appendChild(img);
        card.onclick = () => handleCardClick(card);
        board.appendChild(card);
      });
      currentPlayer = 0;
      scores = [0, 0, 0, 0];
      updateScoreDisplay();
    };

    const modal = document.getElementById("imageModal");
    const modalImage = document.getElementById("modalImage");
    modal.onclick = () => { modal.style.display = "none"; };

    function handleCardClick(card) {
      if (lockBoard || card.classList.contains("flipped")) return;
      const img = card.querySelector("img");
      img.style.visibility = "visible";
      card.classList.add("flipped");

      if (!firstCard) {
        firstCard = card;
        return;
      }

      const secondCard = card;
      lockBoard = true;

      const img1 = firstCard.querySelector("img").src;
      const img2 = secondCard.querySelector("img").src;

      if (img1 === img2) {
        setTimeout(() => {
          modal.style.display = "flex";
          modalImage.src = img1;
          const checkClose = setInterval(() => {
            if (modal.style.display === "none") {
              firstCard.classList.remove("flipped");
              secondCard.classList.remove("flipped");
              scores[currentPlayer]++;
              updateScoreDisplay();
              checkWin();
              lockBoard = false;
              firstCard = null;
              clearInterval(checkClose);
            }
          }, 200);
        }, 500);
      } else {
        setTimeout(() => {
          firstCard.querySelector("img").style.visibility = "hidden";
          secondCard.querySelector("img").style.visibility = "hidden";
          firstCard.classList.remove("flipped");
          secondCard.classList.remove("flipped");
          currentPlayer = (currentPlayer + 1) % playerCount;
          updateScoreDisplay();
          lockBoard = false;
          firstCard = null;
        }, 1000);
      }
    }
  </script>
</body>
</html>
